<!DOCTYPE html><html lang="zh-tw"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="DD&#39;s 分享部落格"><meta name="author" content="DD"><meta property="og:title" content="忍者 Chapter2. 在執行時期產生網頁"><meta property="og:description" content="DD&#39;s 分享部落格"><meta property="og:site_name" content="DD&#39;s Blog"><meta property="og:type" content="article"><meta property="og:image" content="https://diyunhung.github.iohttps://i.imgur.com/Uh0Kukb.jpg"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://diyunhung.github.iohttps://i.imgur.com/Uh0Kukb.jpg"><title>忍者 Chapter2. 在執行時期產生網頁 - DD&#39;s Blog</title><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/style.css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"><!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]--><link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"><link rel="icon" href="https://ca.slack-edge.com/T04NQNSUB-USA2U1SFP-e94a72abd9c0-512"><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="DD's Blog" type="application/atom+xml"></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="navbar-header page-scroll"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">DD's Blog</a></div><div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1"><ul class="nav navbar-nav navbar-right"><li><a href="/">Home</a></li><li><a href="/archives">Archives</a></li><li><a href="/tags">Tags</a></li><li><a href="/categories">Categories</a></li><li><a href="https://github.com/diyunhung" target="_blank" rel="noopener"><i class="fa fa-github fa-stack-2x"></i></a></li></ul></div></div></nav><header class="intro-header" style="background-image:url(https://imgur.com/cDhxgqu.png)"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><h1>忍者 Chapter2. 在執行時期產生網頁</h1><span class="meta">2020-05-25</span></div></div></div></div></header><article><div class="container"><div class="row"><div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags"><a href="/tags/javascript/">#javascript</a></div><div class="col-lg-4 col-md-5 post-categories"><a href="/categories/JS新手村/">JS新手村</a></div><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><h1 id="忍者-Chapter2-在執行時期產生網頁"><a class="header-anchor" href="#忍者-Chapter2-在執行時期產生網頁"></a>忍者 Chapter2. 在執行時期產生網頁</h1><h2 id="Web應用程式生命週期"><a class="header-anchor" href="#Web應用程式生命週期"></a>Web應用程式生命週期</h2><p>❗️ javascript如何適應這個生命週期</p><ul><li>瀏覽器能否用遠正確地根據HTML代碼產生出網頁？</li><li>一個Web應用程式可以同時處理多少事件？</li><li>為什麼瀏覽器必須使用事件佇列來處理多的事件？</li></ul><h3 id="生命週期概述"><a class="header-anchor" href="#生命週期概述"></a>生命週期概述</h3><p><mark>由頁面建立和事件處理兩的階段組成</mark></p><ol><li>開始於使用者輸入URL連結或點擊URL連結</li><li>瀏覽器發聲請求傳送到伺服器</li><li>伺服器處理請求並產生由HTML, CSS, JavaScript所組成的回應頁面</li><li>瀏覽器接收到這個回應頁面，便是Web應用程式開始有生命的一刻</li><li>事件處理，進入一個等待事件發生的迴圈 (6)</li><li>使用者與頁面元素互動(5)</li><li>使用者關閉頁面，網頁的生命週期結束</li></ol><h2 id="頁面建立階段"><a class="header-anchor" href="#頁面建立階段"></a>頁面建立階段</h2><p>透過</p><ol><li>解析HTML並建立文件物件模型(DOM)</li><li>執行Javascript程式</li></ol><p>瀏覽器根據需要，在這兩個步驟切換許多次</p><h3 id="解析HTML並建立DOM"><a class="header-anchor" href="#解析HTML並建立DOM"></a>解析HTML並建立DOM</h3><ul><li>一次處理一個HTML元素</li><li>一個節點可以有任何數量的子結點</li><li>相同父元素的子節點稱為兄弟元素</li><li>遇到特殊類型的HTML元素（如script），瀏覽器會值時停止由HTML代碼來建立DOM，而開始執行JavaScript</li></ul><p>DOM由HTML所建構，但兩者不相同。<br>HTML為建立最初的DOM所遵循的藍圖，瀏覽器會修復在藍圖中發現的問題並建立有效的DOM</p><div class="success"><p>HTML最新版本為HTML5<br><a href="https://html.spec.whatwg.org/" target="_blank" rel="noopener">規格</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/HTML5" target="_blank" rel="noopener">Mozille</a></p><p>DOM為DOM3<br><a href="https://dom.spec.whatwg.org/" target="_blank" rel="noopener">規格</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model" target="_blank" rel="noopener">Mozille</a></p></div><h3 id="執行JAVAScript程式碼"><a class="header-anchor" href="#執行JAVAScript程式碼"></a>執行JAVAScript程式碼</h3><p>script中所有的JavaScript由瀏覽器的JavaScipt引擎執行</p><table><thead><tr><th>瀏覽器</th><th>JavaScript引擎</th></tr></thead><tbody><tr><td>Firefox</td><td>Spidermonkey</td></tr><tr><td>Chrome、Opera</td><td>V8</td></tr><tr><td>Edge、IE</td><td>Chakra</td></tr></tbody></table><p>JS程式碼的主要目的為提供頁面的行為，瀏覽器藉由一個全域物件提供一組API，讓JS引擎與頁面互動並修改頁面</p><h4 id="JavaScript中的全域物件"><a class="header-anchor" href="#JavaScript中的全域物件"></a>JavaScript中的全域物件</h4><p>瀏覽器給JS引擎的主要全域物件是window物件，代表頁面所屬的瀏覽器視窗。<br>window是一個特殊的全域物件，可以透過它還存取所有其他的全域物件、全域變數及瀏覽器API。<br>window最重要的屬性是<code>document</code>，也就是目前頁面的DOM結構<br>JS可以任意改變頁面上的DOM結構。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> first = <span class="built_in">document</span>.getElementById(<span class="string">'first'</span>)</span><br></pre></td></tr></table></figure><p>使用<code>document</code>全域物件從DOM結構找出ID為<code>first</code>的元素</p><h3 id="不同類型的JavaScript"><a class="header-anchor" href="#不同類型的JavaScript"></a>不同類型的JavaScript</h3><p>分為<mark>全域程式(Global code)</mark> 及 <mark>函式程式(function code)</mark><br>兩者主要的區別是它們所在的位置。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="comment">//函式程式</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addMessage</span>(<span class="params">element, message</span>)</span>&#123;</span><br><span class="line"><span class="keyword">var</span> messageElement = <span class="built_in">document</span>.createElement(<span class="string">"li"</span>);</span><br><span class="line">messageElement.textContent = message;</span><br><span class="line">element.appendChild(messageElement);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//全域程式</span></span><br><span class="line"><span class="keyword">var</span> first = <span class="built_in">document</span>.getElementById(<span class="string">"first"</span>);</span><br><span class="line">addMessage(first, <span class="string">"Page loading"</span>);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>全域程式會被JS引擎自動的逐行直接執行。<br>函式程式的執行必須由其他程式如全域程式、其他函式或由瀏覽器呼叫。</p><h3 id="在頁面建立階段執行JavaScript程式碼"><a class="header-anchor" href="#在頁面建立階段執行JavaScript程式碼"></a>在頁面建立階段執行JavaScript程式碼</h3><p>瀏覽器在頁面建立階段遇到<code>script</code>節點時會暫停使用HTML代碼來建立DOM結構，並開始執行JS程式碼。</p><p>JS可以任意的修改DOM結構：建立新節點、修改或刪除現有節點，但不能修改尚未建立的元素</p><div class="warning"><p>人們傾向把script放在頁面底部的原因之一，不必擔心特定的HTML元素有沒有被讀到</p></div><p>當執行完script中的最後一行code，瀏覽器並離開JS執行模式，並繼續處理HTML代碼來建立其他的DOM節點，並反覆的上述行為。</p><p>此時已執行過的script元素中，由使用者定義的全域變數能繼續被其他的script中元素的JS所存取ㄝ，因為存放了所有全域變數的window的全域物件，在頁面的整個生命週期內都是有效且可以存取的。</p><p>當瀏覽器處理完所有的HTML元素，頁面建立階段完成，並進入生命週期第二部分<mark>事件處理</mark></p><h2 id="事件處理"><a class="header-anchor" href="#事件處理"></a>事件處理</h2><p>在頁面建立階段，JS除了影響全域狀態及修改DOM結構外，還可以註冊事件監聽器（處理器），即在事件發生時要執行的函式。</p><h3 id="事件處理概述"><a class="header-anchor" href="#事件處理概述"></a>事件處理概述</h3><p>瀏覽器執行環境的核心為一次執行一段程式碼，為了避免大量阻塞，瀏覽器需要一種方法來追蹤<mark>已發生但尚未處理的事件</mark></p><p>所有已發生事件都會按照順序放置在同一個事件佇列中，交由瀏覽器檢測。</p><ul><li>瀏覽器檢查事件佇列的頂部</li><li>如果沒有事件，瀏覽器會持續檢查</li><li>如果有一事件，瀏覽器會存取他，並執行處理程式。執行期間，剩餘待處理事件間耐心等待直到被處理</li></ul><p>避免編寫需要大量執行時間的事件處理程式，會導致WEB無法產生回應</p><div class="info"><p>將事件放入事件佇列的瀏覽器工作機制，是在頁面建立和事件處理階段之外。判斷事件何時發生，並放入事件佇列的這些動作並不在處理事件的執行緒中</p></div><h3 id="事件是非同步的"><a class="header-anchor" href="#事件是非同步的"></a>事件是非同步的</h3><p>無法預測事件的發生的順序，因此事件的處理、對事件處理的函式呼叫是非同步的。</p><p>可能會發生的事件</p><ul><li>瀏覽器事件，如頁面處於以載入會未載入的狀態</li><li>網路事件，如來自伺服器的回應Ajax事件、伺服器端事件）</li><li>使用者事件，如點擊滑鼠、移動滑鼠、按下鍵盤</li><li>計時器事件，如等候逾時或間隔性的觸發條件</li></ul><p>程式碼是在事前完成設置，以便在之後執行。<br>除了全域程式，在頁面上大多的程式都是某些事件的結果而被執行。</p><h3 id="註冊事件處置器"><a class="header-anchor" href="#註冊事件處置器"></a>註冊事件處置器</h3><p>Event-handler registration, 事件處置器是在特定的事件時發生執行的函式。<br>有兩種註冊事件方式：</p><ul><li>將函式指定給特殊屬性</li><li>使用內建的addEventListener方法</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;;</span><br><span class="line"><span class="comment">//針對load事件註冊一個事件處理器</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.body.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;;</span><br><span class="line"><span class="comment">//對document主體的click事件註冊一個事件處理器</span></span><br></pre></td></tr></table></figure><p>不建議使用以上方式，缺點是某一特定事件只能指派一個事件處理器，很容易蓋掉之前的事件處理函式。</p><p>一個好的替代方式<code>addEventListener</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="built_in">document</span>.body.addEventListener(<span class="string">"mousemove"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> second = <span class="built_in">document</span>.getElementById(<span class="string">"second"</span>);</span><br><span class="line">addMessage(second, <span class="string">"Event: mousemove"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.body.addEventListener(<span class="string">"click"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">var</span> second = <span class="built_in">document</span>.getElementById(<span class="string">"second"</span>);</span><br><span class="line">addMessage(second, <span class="string">"Event: click"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><h3 id="處理事件"><a class="header-anchor" href="#處理事件"></a>處理事件</h3><p>事件處理的主要概念適當事件發生時，瀏覽器呼叫相關的事件處理器。</p><p>模擬情境</p><ol><li>當頁面建置完成使用者開始移動滑鼠即點擊滑鼠</li><li>瀏覽器一順序加入將mousemove和click事件放置到事件佇列上</li><li>事件處理階段：佇列頂端有一個mousemove事件，並執行相關事件處理器，此時click事件等待中</li><li>mousemove最後一行執行完畢，並且JS引擎退出該事件函式，mousemove事件處理完成</li><li>事件迴圈再次檢查佇列，找到click事件並執行</li><li>（重複動作直到使用者關閉Web）</li></ol><h2 id="總結"><a class="header-anchor" href="#總結"></a>總結</h2><ul><li>瀏覽器接收HTML代碼作為建立DOM結構的藍圖，而DOM就是客戶端WEB的的結構表現</li><li>我們透過Javascript程式動態的修改DOM結構，以便為WEB展現動態行為</li><li>客戶端的WEB執行分為兩個階段：<ul><li>頁面建立：處理HTML以建立DOM結構，遇到<code>&lt;script&gt;</code>執行全域程式，執行時可修改DOM結構，及註冊事件處理器(addEventListener)</li><li>事件處理：按照事件產生的順序逐一執行，仰賴事件佇列，事件按照他們的發生的順序被儲存起來。事件回圈會一直檢查事件佇列是否有事件，如果有，呼叫執行函式</li></ul></li></ul><h2 id="名詞解釋"><a class="header-anchor" href="#名詞解釋"></a>名詞解釋</h2><ul><li>DOM(Document Object Model)文件物件模型：<br>客戶端Web使用者介面的結構化表示，只少一開始，他是由Web中的HTML代碼所構成</li><li>事件：<br>絕大多數的JS代碼都是事件驅動的應用程式，意味著程式碼都是為了回應特定事件而執行，事件包含網路事件、計時器、使用者事件</li><li>瀏覽器API:<br>瀏覽器提供了一組API，允許我們存取設備資訊、在本地端存取資料或與遠端伺服器通訊</li></ul></div><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"></div></div></div></article><hr><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href="https://github.com/diyunhung" target="_blank"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href="mailto:lisa0903@gmail.com" target="_blank"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">&copy; 2020 DD<br></p><p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p><p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p></div></div></div></footer><script src="//code.jquery.com/jquery-2.1.4.min.js"></script><script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script></body></html>